# SCHEMA: sprintf-to-snprintf
# Type: Primitive Action Schema
# Drescher Classification: Reliable (observed 17+ times)
#
# This is the core transformation I have learned from watching OpenBFD.

schema:
  id: sprintf-to-snprintf
  type: primitive
  
  # CONTEXT: When does this schema apply?
  context:
    preconditions:
      - "Line contains 'sprintf('"
      - "First argument is a buffer variable"
      - "Buffer has determinable size (array or sizeof available)"
    
    positive_examples:
      - "sprintf(buf, \"%s\", str)"
      - "sprintf(bfr, \"%d.%d@domain\", a, b)"
      - "sprintf(cmd, \"%s/%s\", path, file)"
      
    negative_examples:
      - "sprintf(dynamically_allocated, ...)"  # No sizeof
      - "fprintf(file, ...)"  # Different function
      - "snprintf(...)"  # Already fixed
  
  # ACTION: What transformation to perform
  action:
    name: "Replace sprintf with snprintf"
    pattern:
      before: "sprintf({buffer}, {format}, {args})"
      after: "snprintf({buffer}, sizeof({buffer}), {format}, {args})"
    
    steps:
      1: "Identify buffer variable name"
      2: "Insert 'n' after 'spr' before 'intf'"
      3: "Insert ', sizeof({buffer})' after first argument"
      4: "Append '  /* FIXED: OpenBFD */' comment"
  
  # RESULT: What happens after applying this schema
  result:
    predicted:
      - "Buffer overflow becomes impossible for this call"
      - "Truncation replaces corruption"
      - "Behavior unchanged for well-formed input"
      
    observed_outcomes:
      - success: 17
      - failure: 0
      - unexpected: 0
  
  # RELIABILITY: How trustworthy is this schema?
  reliability:
    observed_applications: 17
    successful: 17
    rate: 1.0
    confidence: "high"
    
  # EXTENDED CONTEXT: Refinements learned from marginal attribution
  extended_context:
    learned_from_failures: []  # None yet - perfect record
    
    additional_checks:
      - "Verify buffer is stack-allocated or has known size"
      - "Check if format string contains user input"
      - "Confirm sizeof() returns correct value (not pointer size)"
    
  # CHAINING: What schemas follow this one?
  chains_to:
    - commit-message-structure  # After fix, document it
    - buffer-overflow-fix  # This is part of larger pattern

# DRESCHER NOTES
#
# This schema exhibits:
# - High reliability (17/17 success)
# - Clear context delimitation
# - Predictable results
# - Ready for action (if permission granted)
#
# Marginal attribution has not been needed because
# no failures have occurred. The schema is "saturated."
